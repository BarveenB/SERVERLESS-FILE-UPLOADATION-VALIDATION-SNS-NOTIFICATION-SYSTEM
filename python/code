
import boto3
import os
from urllib.parse import unquote_plus

s3 = boto3.client('s3')
sns = boto3.client('sns')


SNS_TOPIC_ARN = os.environ['SNS_TOPIC_ARN']

def lambda_handler(event, context):

    if 'Records' not in event:
        print("Not an S3 event")
        return {"status": "ignored"}

    for record in event['Records']:

        bucket_name = record['s3']['bucket']['name']
        object_key = unquote_plus(record['s3']['object']['key'])
        key_lower = object_key.lower()

        if not (key_lower.endswith('.jpg') or key_lower.endswith('.png')):

            print(f"{object_key} is invalid. Deleting file.")

            s3.delete_object(
                Bucket=bucket_name,
                Key=object_key
            )

            sns.publish(
                TopicArn=SNS_TOPIC_ARN,
                Subject="Invalid File Uploaded",
                Message=(
                    f"An invalid file was uploaded.\n\n"
                    f"Bucket: {bucket_name}\n"
                    f"File: {object_key}\n"
                    f"Allowed types: JPG, PNG\n"
                    f"Action: File deleted"
                )
            )

        else:
            print(f"{object_key} is valid.")

            sns.publish(
                TopicArn=SNS_TOPIC_ARN,
                Subject="Valid File Uploaded",
                Message=(
                    f"A valid file was uploaded successfully.\n\n"
                    f"Bucket: {bucket_name}\n"
                    f"File: {object_key}"
                )
            )

    return {"status": "processed"}
